{% extends 'admin/base.html' %} 

{% block head %}
<title>Gestion des joueurs</title>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="header-actions">Gestion des Joueurs</h2>
</div>

<details class="admin-filter" {{ 'open' if request.method == 'POST' else '' }}>
    <summary>
        <span>üîç Rechercher / Filtrer</span>
    </summary>
    <div class="filter-content">
        <form action="{{ url_for('users.find_user') }}" method="POST" autocomplete="off" style="display: grid; gap: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" name="nom" placeholder="Nom" value="{{ request.form.nom }}" />
                <input type="text" name="username_finding" placeholder="Username" value="{{ request.form.username_finding }}" />
            </div>
            
            <input type="text" name="email" placeholder="Email" value="{{ request.form.email }}" />
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="number" name="age" placeholder="Age" value="{{ request.form.age }}" />
                <select name="classe">
                    <option value="">-- Classe --</option>
                    <option value="septieme" {% if request.form.classe=="septieme" %} selected {% endif %}>7e A.F.</option>
                    <option value="huitieme" {% if request.form.classe=="huitieme" %} selected {%endif%}>8e A.F.</option>
                    <option value="neuvieme" {% if request.form.classe=="neuvieme" %} selected {%endif%}>9e A.F.</option>
                    <option value="secondaire 1" {% if request.form.classe=="secondaire 1" %} selected {%endif%}>NS1</option>
                    <option value="secondaire 2" {% if request.form.classe=="secondaire 2" %} selected {%endif%}>NS2</option>
                    <option value="secondaire 3" {% if request.form.classe=="secondaire 3" %} selected {%endif%}>NS3</option>
                    <option value="secondaire 4" {% if request.form.classe=="secondaire 4" %} selected {%endif%}>NS4</option>
                    <option value="Direction" {% if request.form.classe=="Direction" %} selected {%endif%}>Direction</option>
                </select>
            </div>
            
            <button type="submit" class="btn-primary btn-dang">Lancer la recherche</button>
        </form>
    </div>
</details>

{% if users %}
<div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Utilisateur</th>
                <th>Solde</th>
                <th>Classe</th>
                {% if current_user.role == "super_admin" %}
                <th class="email_th">Email</th>
                {% endif %}
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <strong>{{ user['prenom'] }} {{ user['nom'] }}</strong><br>
                    <span style="color:#64748b; font-size:0.85em;">@{{ user['username'] }}</span>
                </td>
                <td style="font-weight:bold; color: var(--admin-primary);">{{ format_money(user['solde'] / 100) }} HTG</td>
                <td>{{ user['classe'] }}</td>
                {% if current_user.role == "super_admin" %}
                <td>{{ user["email"] }}</td>
                {% endif %}
                <td>
                    {% if user['actif'] == 1 %}
                    <span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:10px; font-size:0.8em;">Actif</span>
                    {% else %}
                    <span style="background:#fee2e2; color:#991b1b; padding:2px 8px; border-radius:10px; font-size:0.8em;">Suspendu</span>
                    {% endif %}
                </td>
                <td class="table-actions">
                    {% if user['username'] != current_user['username'] or current_user['role'] == "super_admin" %}
                        <a href="#action-zone" onclick="preRemplir('{{ user['username'] }}')" class="text-edit" style="color: blue;">G√©rer $$</a>
                        <a href="{{ url_for('users.fiches', user_id = user['id']) }}" onclick="preRemplir('{{ user['username'] }}')" class="text-edit" style="color: blue;">Fiches</a>
                        <a href="javascript:void(0)" onclick="{{ 'confirmBan' if user['actif'] == 1 else 'confirmRet' }}('{{ user['username'] }}')" class="text-delete" style="color: red;">
                            {{ 'Bannir' if user['actif'] == 1 else 'R√©tablir' }}
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif no_users %}
<div style="text-align:center; padding:30px; color:#64748b;">Aucun utilisateur trouv√©.</div>
{% endif %}

<div id="action-zone" style="margin-top: 30px; display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
    
    <details class="admin-filter">
        <summary>‚ûï Cr√©diter un compte</summary>
        <div class="filter-content">
            <form action="{{ url_for('users.credit_user') }}" method="POST">
                <input type="text" name="username_credit" id="username_credit" placeholder="Username" required style="margin-bottom:10px;">
                <input type="number" name="solde_credit" id="solde_credit" step="any" placeholder="Montant √† ajouter" required style="margin-bottom:10px;">
                <button type="submit" class="btn-success btn-dang" style="width:100%">Valider Cr√©dit</button>
            </form>
        </div>
    </details>

    <details class="admin-filter">
        <summary>‚ûñ D√©biter un compte</summary>
        <div class="filter-content">
            <form action="{{ url_for('users.debit_user') }}" method="POST">
                <input type="text" name="username_debit" id="username_debit" placeholder="Username" required style="margin-bottom:10px;">
                <input type="number" name="solde_debit" id="solde_debit" step="any" placeholder="Montant √† retirer" required style="margin-bottom:10px;">
                <button type="submit" class="btn-danger btn-dang" style="width:100%">Valider D√©bit</button>
            </form>
        </div>
    </details>
</div>

<div id="deleteModal" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div style="background: white; padding: 25px; border-radius: 8px; width: 350px; text-align: center;">
        <h4>Confirmation</h4>
        <form id="deleteForm" method="POST" autocomplete="off">
            <input type="text" name="username" placeholder="Votre Username Admin" required style="margin:10px 0;">
            <input type="password" name="password" placeholder="Votre Mot de passe" required style="margin:10px 0;">
            <textarea name="message_ban_ret" rows="3" placeholder="Raison..." style="margin-bottom:10px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button type="button" onclick="closeDeleteModal()" style="background:#ccc; flex:1;">Annuler</button>
                <button type="submit" class="btn-danger btn-dang" style="flex:1;">Confirmer</button>
            </div>
        </form>
    </div>
</div>

<script>
    function preRemplir(username) {
        document.getElementById("username_credit").value = username;
        document.getElementById("username_debit").value = username;
        // Scroll doux vers la zone
        document.getElementById("action-zone").scrollIntoView({ behavior: 'smooth' });
    }
    // ... Reste des scripts JS existants (confirmBan, etc.) ...
    const modal = document.getElementById('deleteModal');
    const form = document.getElementById('deleteForm');

    function confirmBan(username) {
        form.action = `/admin/users/ban/${username}`;
        modal.style.display = 'flex';
    }
    function confirmRet(username) {
        form.action = `/admin/users/ret/${username}`;
        modal.style.display = 'flex';
    }
    function closeDeleteModal() { modal.style.display = 'none'; form.reset(); }
</script>
{% endblock %}
