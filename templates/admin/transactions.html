{% extends 'admin/base.html' %} 

{% block head %}
<style>
    /* --- STYLES SP√âCIFIQUES TRANSACTIONS --- */

    /* Onglets */
    .tabs-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--admin-border);
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        position: relative;
        transition: color 0.3s;
    }

    .tab-btn.active {
        color: var(--admin-primary);
    }

    .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--admin-primary);
        border-radius: 3px 3px 0 0;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Badges & Textes */
    .text-success { color: var(--admin-success); }
    .text-danger { color: var(--admin-danger); }
    .text-muted { color: #64748b; font-size: 0.85em; }
    
    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .badge-depot { background: #dcfce7; color: #166534; }
    .badge-retrait { background: #fee2e2; color: #991b1b; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-danger { background: #fee2e2; color: #991b1b; }

    /* Layout Montant */
    .amount-stack {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    .amount-final {
        font-weight: 700;
        color: var(--admin-text);
        font-size: 1.05em;
    }
    .fee-calc {
        font-size: 0.8em;
        color: #ef4444;
        background: #fef2f2;
        padding: 0 4px;
        border-radius: 4px;
    }

    /* Info Paiement (ID / Tel) */
    .payment-info {
        font-family: monospace;
        background: #f1f5f9;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
        display: inline-block;
        color: #334155;
    }
    .payment-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        margin-right: 5px;
    }

    /* Actions & IA */
    .actions-group {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
    }
    
    .btn-icon {
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: transform 0.1s;
    }
    .btn-icon:active { transform: scale(0.95); }
    .btn-validate { background: var(--admin-success); color: white; }
    .btn-reject { background: #fff; border: 1px solid var(--admin-danger); color: var(--admin-danger); }
    .btn-reject:hover { background: #fef2f2; }
    
    .reject-form {
        display: none; /* Cach√© par d√©faut */
        margin-top: 5px;
    }
    .reject-input {
        padding: 5px;
        border: 1px solid var(--admin-danger);
        border-radius: 4px;
        font-size: 0.8rem;
        width: 120px;
    }
    .btn-confirm-reject {
        background: var(--admin-danger);
        color: white;
        border: none;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
    }

    /* IA Box */
    .ia-box {
        background: #f8fafc;
        border: 1px dashed var(--admin-border);
        border-radius: 8px;
        padding: 8px;
        width: 100%;
        min-width: 200px;
    }
    .ia-input {
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 6px;
        font-size: 0.85rem;
        margin-bottom: 5px;
        height: 35px;
        transition: height 0.2s;
    }
    .ia-input:focus { height: 60px; }
    .btn-ia {
        background: #6366f1; /* Indigo */
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
    }
    .ia-result {
        margin-top: 5px;
        font-size: 0.8rem;
        font-weight: 600;
        min-height: 15px;
    }

    /* --- RESPONSIVE CARD VIEW (MOBILE) --- */
    .mobile-only { display: none; }
    .desktop-only { display: table; }

    @media (max-width: 768px) {
        .desktop-only { display: none; }
        .mobile-only { display: block; }
        
        .tx-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid var(--admin-border);
        }
        .tx-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .tx-user { font-weight: 700; font-size: 1rem; }
        .tx-date { font-size: 0.8rem; color: #94a3b8; }
        
        .tx-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px 0;
        }
        .tx-label { font-size: 0.85rem; color: #64748b; font-weight: 500; }
        
        .tx-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Style sp√©cifique pour les infos de paiement mobile */
        .mobile-payment-details {
            text-align: right;
            background: #f8fafc;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .mp-id { font-family: monospace; font-weight: 700; color: #334155; }
        .mp-phone { font-size: 0.85rem; color: #64748b; }
    }
</style>
{% endblock %} 

{% block content %}
<div class="dashboard-container">
    <h2 class="header-actions">Gestion Financi√®re</h2>

    <div class="tabs-wrapper">
        <button class="tab-btn active" onclick="switchTab('pending', event)">
            ‚è≥ En attente
        </button>
        <button class="tab-btn" onclick="switchTab('history', event)">
            üìú Historique
        </button>
    </div>

    <div id="tab-pending" class="tab-content active">
        {% if demandes %}
        
        <div class="table-responsive desktop-only">
            <table>
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>Type</th>
                        <th>Montant</th>
                        <th>Infos Paiement</th> <th>V√©rification IA</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in demandes %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ d.username }}</div>
                            <div class="text-muted">{{ d.prenom }} {{ d.nom }}</div>
                            <div class="text-muted" style="font-size: 0.75em;">{{ d.created_at }}</div>
                        </td>
                        <td>
                            {% if d.type == 'depot' %}
                                <span class="badge badge-depot">D√âP√îT</span>
                            {% else %}
                                <span class="badge badge-retrait">RETRAIT</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="amount-stack">
                                {% if d.type == 'depot' %}
                                    <span class="text-success" style="font-weight: 700;">+ {{ format_money(d.montant) }} G</span>
                                {% else %}
                                    <span class="text-muted" style="text-decoration: line-through;">{{ format_money(d.montant) }} G</span>
                                    <span class="fee-calc">Frais: -{{ format_money(d.frais) }} G</span>
                                    <span class="amount-final">NET: {{ format_money(d.montant_net) }} G</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="margin-bottom: 4px;">
                                <span class="payment-label">ID:</span>
                                <span class="payment-info">{{ d.moncash_id if d.moncash_id else 'N/A' }}</span>
                            </div>
                            <div>
                                <span class="payment-label">T√©l:</span>
                                <strong>{{ d.telephone }}</strong>
                            </div>
                        </td>
                        <td width="200">
                            <div class="ia-box">
                                <textarea id="sms_input_{{ d.id }}" class="ia-input" placeholder="Coller SMS MonCash..."></textarea>
                                <button type="button" class="btn-ia" onclick="checkWithIA('{{ d.id }}')">ü§ñ Analyser</button>
                                <div id="result_ia_{{ d.id }}" class="ia-result"></div>
                            </div>
                        </td>
                        <td align="right">
                            <form action="{{ url_for('admin.transaction_action') }}" method="POST">
                                <input type="hidden" name="tx_id" value="{{ d.id }}" />
                                
                                <div class="actions-group">
                                    <button type="submit" name="action" value="valider" class="btn-icon btn-validate" onclick="return confirm('Confirmer cette transaction ?');">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                        Valider
                                    </button>
                                    
                                    <button type="button" class="btn-icon btn-reject" onclick="toggleReject('{{ d.id }}')">
                                        Refuser
                                    </button>
                                </div>

                                <div id="reject_area_{{ d.id }}" class="reject-form" style="text-align: right;">
                                    <input type="text" name="raison" class="reject-input" placeholder="Raison du refus" required disabled>
                                    <button type="submit" name="action" value="refuser" class="btn-confirm-reject">Confirmer</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mobile-only">
            {% for d in demandes %}
            <div class="tx-card">
                <div class="tx-card-header">
                    <div>
                        <div class="tx-user">{{ d.username }}</div>
                        <div class="text-muted">{{ d.prenom }} {{ d.nom }}</div>
                    </div>
                    <div class="tx-date">{{ d.created_at }}</div>
                </div>

                <div class="tx-row">
                    <span class="tx-label">Type</span>
                    {% if d.type == 'depot' %}
                        <span class="badge badge-depot">D√âP√îT</span>
                    {% else %}
                        <span class="badge badge-retrait">RETRAIT</span>
                    {% endif %}
                </div>

                <div class="tx-row">
                    <span class="tx-label">D√©tails Paiement</span>
                    <div class="mobile-payment-details">
                        <div class="mp-id">ID: {{ d.moncash_id if d.moncash_id else 'N/A' }}</div>
                        <div class="mp-phone">üìû {{ d.telephone }}</div>
                    </div>
                </div>

                <div class="tx-row">
                    <span class="tx-label">Montant</span>
                    <div style="text-align: right;">
                        {% if d.type == 'depot' %}
                            <span class="text-success" style="font-weight: 700; font-size: 1.2rem;">+ {{ format_money(d.montant) }} HTG</span>
                        {% else %}
                            <div class="text-muted">D√©bit: {{ format_money(d.montant) }}</div>
                            <div class="amount-final">√Ä envoyer: {{ format_money(d.montant_net) }} HTG</div>
                        {% endif %}
                    </div>
                </div>

                <div class="tx-actions">
                    <div class="ia-box">
                        <textarea id="sms_input_mob_{{ d.id }}" class="ia-input" placeholder="SMS MonCash..."></textarea>
                        <button type="button" class="btn-ia" onclick="checkWithIA('{{ d.id }}', true)">ü§ñ V√©rifier (IA)</button>
                        <div id="result_ia_mob_{{ d.id }}" class="ia-result"></div>
                    </div>

                    <form action="{{ url_for('admin.transaction_action') }}" method="POST" style="width: 100%;">
                        <input type="hidden" name="tx_id" value="{{ d.id }}" />
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button type="submit" name="action" value="valider" class="btn-icon btn-validate" style="justify-content: center;">
                                ‚úì Valider
                            </button>
                            <button type="button" class="btn-icon btn-reject" onclick="toggleReject('mob_{{ d.id }}')" style="justify-content: center;">
                                X Refuser
                            </button>
                        </div>
                        
                        <div id="reject_area_mob_{{ d.id }}" class="reject-form" style="margin-top: 10px;">
                            <div style="display: flex; gap: 5px;">
                                <input type="text" name="raison" class="reject-input" style="flex:1;" placeholder="Motif du refus..." required disabled>
                                <button type="submit" name="action" value="refuser" class="btn-confirm-reject">OK</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
            <h3 style="color: var(--admin-text);">Tout est √† jour !</h3>
            <p class="text-muted">Aucune transaction en attente de validation.</p>
        </div>
        {% endif %}
    </div>

    <div id="tab-history" class="tab-content">
        {% if historique %}
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Parieur</th>
                        <th>Type</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Admin</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in historique %}
                    <tr>
                        <td class="text-muted" style="font-size: 0.85rem;">{{ h.processed_at }}</td>
                        <td><strong>{{ h.username }}</strong></td>
                        <td>
                            <span style="font-weight: bold; color: {{ 'var(--admin-success)' if h.type == 'depot' else 'var(--admin-danger)' }}">
                                {{ h.type|upper }}
                            </span>
                        </td>
                        <td>{{ format_money(h.montant) }} HTG</td>
                        <td>
                            {% if h.statut == 'valide' %}
                                <span class="badge badge-success">Valid√©</span>
                            {% else %}
                                <span class="badge badge-danger">Refus√©</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.9rem;">
                            üëÆ {{ h.admin_prenom }}
                        </td>
                        <td class="text-muted">{{ h.raison_refus if h.raison_refus else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px;">
            <p class="text-muted">L'historique est vide pour le moment.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Gestion des onglets
    function switchTab(tabName, evt) {
        document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
        document.getElementById("tab-" + tabName).classList.add("active");
        if (evt && evt.currentTarget) evt.currentTarget.classList.add("active");
    }

    // Gestion de l'affichage du champ Refus
    function toggleReject(id) {
        const area = document.getElementById("reject_area_" + id);
        const input = area.querySelector('input');
        
        if (area.style.display === "block") {
            area.style.display = "none";
            input.disabled = true; // Emp√™che l'envoi si cach√©
        } else {
            area.style.display = "block";
            input.disabled = false;
            input.focus();
        }
    }

    // IA Check (Compatible Desktop et Mobile)
    function checkWithIA(txId, isMobile = false) {
        const prefix = isMobile ? "mob_" : "";
        const smsInputId = "sms_input_" + prefix + txId;
        const resultId = "result_ia_" + prefix + txId;

        const sms = document.getElementById(smsInputId).value;
        const resultDiv = document.getElementById(resultId);

        if (!sms.trim()) {
            alert("Veuillez coller le SMS d'abord.");
            return;
        }

        resultDiv.innerHTML = "<span style='color:blue'>‚åõ Analyse...</span>";
        
        fetch("/admin/ia-check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sms: sms, tx_id: txId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.verdict === "VALIDE") {
                resultDiv.innerHTML = `<div style='color:green; margin-top:5px;'>‚úÖ ${data.commentaire} <br><small>Confiance: ${data.confiance}%</small></div>`;
            } else {
                resultDiv.innerHTML = `<div style='color:red; margin-top:5px;'>‚ùå ${data.commentaire}</div>`;
            }
        })
        .catch(err => {
            resultDiv.innerHTML = "‚ö†Ô∏è Erreur r√©seau";
            console.error(err);
        });
    }
</script>
{% endblock %}
