{% extends 'admin/base.html' %} {% block head %}<style>    /* Styles sp√©cifiques pour les onglets */    .tabs-container {        margin-bottom: 20px;        border-bottom: 2px solid #e2e8f0;    }    .tab-btn {        background: none;        border: none;        padding: 10px 20px;        font-size: 1rem;        font-weight: 600;        color: #64748b;        cursor: pointer;        position: relative;    }    .tab-btn.active {        color: var(--admin-primary);    }    .tab-btn.active::after {        content: "";        position: absolute;        bottom: -2px;        left: 0;        width: 100%;        height: 2px;        background: var(--admin-primary);    }    .tab-content {        display: none;        animation: fadeIn 0.3s ease;    }    .tab-content.active {        display: block;    }    @keyframes fadeIn {        from {            opacity: 0;            transform: translateY(5px);        }        to {            opacity: 1;            transform: translateY(0);        }    }    .badge {        padding: 4px 8px;        border-radius: 4px;        font-size: 0.8rem;        font-weight: bold;    }    .badge-success {        background: #dcfce7;        color: #166534;    }    .badge-danger {        background: #fee2e2;        color: #991b1b;    }    .badge-warning {        background: #fef9c3;        color: #854d0e;    }</style>{% endblock %} {% block content %}<div class="admin-container" style="padding: 20px">    <h2 class="header-actions">Gestion Financi√®re</h2>    <div class="tabs-container">        <button class="tab-btn active" onclick="switchTab('pending', event)">‚è≥ En attente</button>        <button class="tab-btn" onclick="switchTab('history', event)">üìú Historique des Op√©rations</button>    </div>    <div id="tab-pending" class="tab-content active">        {% if demandes %}        <div style="overflow-x: auto">            <table class="table-responsive">                <thead>                    <tr>                        <th>Utilisateur</th>                        <th>Type</th>                        <th>Montant (D√©tails)</th>                         <th>Infos (MonCash/T√©l)</th>                        <th>Date</th>                        <th>Action</th>                        <th>V√©rification</th>                    </tr>                </thead>                <tbody>                    {% for d in demandes %}                    <tr style="border-bottom: 1px solid #ddd">                                                <td style="padding: 10px">                            <strong>{{ d.username }}</strong>                            <br />                            <small>{{ d.prenom }} {{ d.nom }}</small>                        </td>                        <td>                            <span style="font-weight:bold; color: {{ 'green' if d.type == 'depot' else 'red' }};">{{ d.type|upper }}</span>                        </td>                        <td>                            {% if d.type == 'depot' %}                                <span style="font-weight:bold; color: green; font-size: 1.1em;">+ {{ format_money(d.montant) }} HTG</span>                            {% else %}                                <div style="display: flex; flex-direction: column;">                                    <span style="color: #666; font-size: 0.9em;">D√©bit√©: {{ format_money(d.montant) }} G</span>                                    <span style="color: #d32f2f; font-size: 0.8em;">Frais: -{{ format_money(d.frais) }} G</span>                                    <strong style="color: #000; border-top: 1px solid #ccc; margin-top: 2px;">                                        √Ä ENVOYER : {{ format_money(d.montant_net) }} HTG                                    </strong>                                </div>                            {% endif %}                        </td>                        <td>{{ d.created_at }}</td>                        <td style="padding: 10px">                            <form action="{{ url_for('admin.transaction_action') }}" method="POST" style="display: flex; gap: 5px">                                <input type="hidden" name="tx_id" value="{{ d.id }}" />                                <button type="submit" class="btn-dang" name="action" value="valider" style="background: green; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer" onclick="return confirm('Confirmer cette transaction ?');">‚úì Valider</button>                                <button type="button" onclick="showReject('{{ d.id }}')" style="background: red; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer">X Refuser</button>                                <input type="text" name="raison" id="raison_{{d.id}}" placeholder="Raison refus" style="display: none; width: 100px" />                                <button type="submit" name="action" value="refuser" id="btn_refuse_{{d.id}}" style="display: none; background: #d32f2f; color: white; border: none; padding: 5px">Confirmer Refus</button>                            </form>                        </td>                        <td style="background: #f9f9f9; border: 1px dashed #ccc; padding: 10px">                            <textarea id="sms_input_{{ d.id }}" placeholder="Coller le SMS MonCash ici..." style="width: 100%; height: 40px; font-size: 11px"></textarea>                            <button type="button" onclick="checkWithIA('{{ d.id }}')" style="font-size: 10px; margin-top: 5px; background: #6c5ce7; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer">ü§ñ V√©rifier par IA</button>                            <div id="result_ia_{{ d.id }}" style="margin-top: 5px; font-size: 11px; font-weight: bold"></div>                        </td>                    </tr>                    {% endfor %}                </tbody>            </table>        </div>        {% else %}        <div style="text-align: center; padding: 40px; color: #94a3b8">            <p>‚úÖ Aucune transaction en attente.</p>        </div>        {% endif %}    </div>    <div id="tab-history" class="tab-content">        {% if historique %}        <div style="overflow-x: auto">            <table class="table-responsive">                <thead>                    <tr>                        <th>Date Traitement</th>                        <th>Parieur</th>                        <th>Type</th>                        <th>Montant</th>                        <th>Statut</th>                        <th>Trait√© par (Admin)</th>                        <th>Note/Raison</th>                    </tr>                </thead>                <tbody>                    {% for h in historique %}                    <tr>                        <td>{{ h.processed_at }}</td>                        <td>{{ h.username }}</td>                        <td style="font-weight: bold; color: {{ 'green' if h.type == 'depot' else 'red' }}">{{ h.type|upper }}</td>                        <td>{{ format_money(h.montant) }} HTG</td>                        <td>                            {% if h.statut == 'valide' %}                            <span class="badge badge-success">Valid√©</span>                            {% else %}                            <span class="badge badge-danger">Refus√©</span>                            {% endif %}                        </td>                        <td style="font-weight: bold; color: var(--admin-primary)">üëÆ {{ h.admin_prenom }} {{ h.admin_nom }}</td>                        <td style="font-size: 0.9em; color: #666">{{ h.raison_refus if h.raison_refus else '-' }}</td>                    </tr>                    {% endfor %}                </tbody>            </table>        </div>        {% else %}        <p style="text-align: center; padding: 20px">L'historique est vide pour le moment.</p>        {% endif %}    </div></div><script>    function switchTab(tabName, evt) {        // 1. Cacher tous les contenus d'onglets        document.querySelectorAll(".tab-content").forEach(el => {            el.classList.remove("active");        });        // 2. Retirer la classe 'active' de tous les boutons        document.querySelectorAll(".tab-btn").forEach(el => {            el.classList.remove("active");        });        // 3. Afficher le contenu de l'onglet s√©lectionn√©        const targetContent = document.getElementById("tab-" + tabName);        if (targetContent) {            targetContent.classList.add("active");        }        // 4. Ajouter la classe 'active' au bouton cliqu√©        if (evt && evt.currentTarget) {            evt.currentTarget.classList.add("active");        }    }    // Gestion Refus    function showReject(id) {        // On cible le champ texte "Raison"        const input = document.getElementById("raison_" + id);        // On cible le bouton "Confirmer Refus"        const btn = document.getElementById("btn_refuse_" + id);        // V√©rification de s√©curit√©        if (!input || !btn) {            console.error("√âl√©ments introuvables pour l'ID transaction : " + id);            return;        }        // Bascule de l'affichage        if (input.style.display === "none") {            input.style.display = "inline-block";            btn.style.display = "inline-block";            input.focus(); // Place le curseur directement dans le champ        } else {            input.style.display = "none";            btn.style.display = "none";            input.value = ""; // Optionnel : efface la raison si on annule        }    }    function checkWithIA(txId) {        const sms = document.getElementById("sms_input_" + txId).value;        const resultDiv = document.getElementById("result_ia_" + txId);        if (!sms) return alert("Collez le SMS d'abord !");        resultDiv.innerHTML = "‚åõ Analyse en cours...";        resultDiv.style.color = "blue";        fetch("/admin/ia-check", {            method: "POST",            headers: { "Content-Type": "application/json" },            body: JSON.stringify({ sms: sms, tx_id: txId })        })            .then(response => response.json())            .then(data => {                if (data.verdict === "VALIDE") {                    resultDiv.innerHTML = "‚úÖ " + data.commentaire + " (Confiance: " + data.confiance + "%)";                    resultDiv.style.color = "green";                } else {                    resultDiv.innerHTML = "‚ùå " + data.commentaire;                    resultDiv.style.color = "red";                }            })            .catch(err => {                resultDiv.innerHTML = "‚ö†Ô∏è Erreur de connexion";            });    }</script>{% endblock %}